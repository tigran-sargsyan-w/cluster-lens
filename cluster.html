<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ClusterLens ‚Äî Map</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a26; --muted:#9aa4b2; --text:#e7edf5;
      --line:#243044; --good:#2ecc71; --bad:#ff5c5c; --warn:#f5c542;
      --chip:#1b2637;
    }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1100px; margin:0 auto; padding:22px; }
    .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .title{ font-size:18px; color:var(--muted); }
    .btn{
      background:transparent; border:1px solid var(--line); color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer;
    }
    .btn:hover{ border-color:#3a4b6b; }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .grid{ display:grid; gap:14px; grid-template-columns: 360px 1fr; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:16px; padding:16px;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }

    .chip{
      display:inline-flex; gap:8px; align-items:center;
      background:var(--chip); border:1px solid var(--line);
      padding:8px 10px; border-radius:999px; color:var(--text);
      font-size:13px;
    }
    .row{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .muted{ color:var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    /* Tabs */
    .tabs{ display:flex; gap:10px; margin-bottom:12px; }
    .tab{
      padding:10px 12px; border-radius:12px; border:1px solid var(--line);
      cursor:pointer; color:var(--muted); background:transparent;
    }
    .tab.active{ color:var(--text); border-color:#3a4b6b; background:rgba(255,255,255,.04); }

    /* Map */
    .mapWrap{ display:grid; grid-template-columns: 1fr 1fr; gap:18px; }
    /* @media (max-width: 980px){ .mapWrap{ grid-template-columns: 1fr; } } */
    @media (max-width: 980px){
      .grid > .card:last-child{
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .mapWrap{
        min-width: 420px;
      }
    }

    .zoneTitle{ font-size:42px; font-weight:750; text-align:center; opacity:.92; margin:10px 0 12px; }
    .zone{ padding:10px; }
    .zoneInner{ display:grid; gap:12px; }
    .zoneRow{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap:14px;
      padding-top: 15px;
      padding-bottom:15px;
      border-bottom:1px solid var(--line);
    }
    .zoneRow:last-child{
      padding-bottom:0;
      border-bottom:none;
    }
    .rowLabel{ font-size:28px; font-weight:700; opacity:.92; }

    .seats{ display:flex; gap:8px; align-items:flex-end; }
    .seatCol{ display:flex; flex-direction:column; align-items:center; gap:6px; }
    .seatCol.up{ transform: translateY(-14px); }
    .seatCol.down{ transform: translateY(10px); }

    .seat{
      width:44px; height:44px; border-radius:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      position:relative;
      overflow:hidden;
    }
    .seat.free{ background: rgba(255,255,255,.03); }
    .seat.occupied{ background: rgba(255,255,255,.10); }
    .seat.blocked{ background: rgba(255,92,92,.08); border-color: rgba(255,92,92,.35); }

    .seat img{
      width:100%; height:100%; object-fit:cover;
      transform: scale(1.02);
      filter: saturate(1.05);
    }
    .seat .ban{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
    }
    .seatNum{ font-size:14px; color:var(--muted); }

    .tooltip{
      position:absolute; left:50%; bottom:52px; transform:translateX(-50%);
      background:#0b0f17; border:1px solid var(--line);
      padding:8px 10px; border-radius:12px; white-space:nowrap;
      font-size:12px; color:var(--text);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      opacity:0; pointer-events:none;
      transition:opacity .12s ease;
    }
    .seat:hover .tooltip{ opacity:1; }

    .statBig{ display:flex; justify-content:space-between; align-items:flex-end; gap:12px; }
    .statValue{ font-size:48px; font-weight:800; line-height:1; }
    .statLabel{ color:var(--muted); margin-bottom:8px; }
    .barList{ display:grid; gap:10px; margin-top:12px; }
    .barRow{ display:grid; grid-template-columns: 62px 1fr auto; gap:10px; align-items:center; }
    .bar{ height:10px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.03); overflow:hidden; }
    .bar > i{ display:block; height:100%; width:0%; background:rgba(46,204,113,.35); }

    .msg{
      margin-top:12px;
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(255,255,255,.02);
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }

    .modalOverlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 24px;
  z-index: 9999;
}
.modalOverlay.show{ display:flex; }

.modal{
  width: min(500px, 100%);
  aspect-ratio: 1 / 1;
  margin-top: 18px;
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: 18px;
  box-shadow: 0 18px 50px rgba(0,0,0,.5);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.modalHeader{
  display:flex;
  align-items:center;
  justify-content: space-between;
  padding: 14px 16px;
  background: rgba(255,255,255,.02);
  border-bottom: 1px solid var(--line);
}

.modalTitle{
  color: var(--muted);
  font-size: 13px;
}

.modalClose{
  background: transparent;
  border: 1px solid var(--line);
  color: var(--text);
  border-radius: 12px;
  padding: 8px 10px;
  cursor: pointer;
}
.modalClose:hover{ border-color:#3a4b6b; }

.modalBody{
  display:flex;
  gap: 16px;
  padding: 16px;
  align-items: center;
  justify-content: center;
  flex: 1;
  text-align: center;
  flex-direction: column;
}

.modalAvatar{
  width: 196px;
  height: 196px;
  border-radius: 18px;
  border: 1px solid var(--line);
  overflow:hidden;
  background: rgba(255,255,255,.04);
  flex: 0 0 auto;
}
.modalAvatar img{
  width:100%;
  height:100%;
  object-fit: cover;
}

.modalInfo h2{
  margin: 0 0 6px;
  font-size: 22px;
}
.modalInfo .sub{
  color: var(--muted);
  font-size: 13px;
  margin-bottom: 10px;
}

.modalActions{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-bottom: 12px;
}

.modalLink{
  text-decoration: none;
  font-size: 13px;
  padding: 8px 12px;
  border-radius: 999px;
  background: var(--chip);
  border: 1px solid var(--line);
  color: var(--text);
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.modalLink:hover{ border-color:#3a4b6b; }
.modalLink[aria-disabled="true"]{
  opacity:.5;
  pointer-events:none;
}

.pill{
  display:inline-flex;
  gap:8px;
  align-items:center;
  padding: 8px 10px;
  border-radius: 999px;
  background: var(--chip);
  border: 1px solid var(--line);
  font-size: 13px;
  color: var(--text);
}


  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">ClusterLens (POC)</div>
      <div style="display:flex; gap:10px;">
        <button class="btn" id="btn-login">Login</button>
        <button class="btn" id="btn-logout">Logout</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: stats -->
      <div class="card" id="stats">
        <div class="chip">üìä Stats</div>
        <div style="height:12px;"></div>

        <div class="statBig">
          <div>
            <div class="statLabel">Occupied</div>
            <div class="statValue" id="occ">‚Äî</div>
          </div>
          <div style="text-align:right;">
            <div class="statLabel">Free</div>
            <div class="statValue" id="free">‚Äî</div>
          </div>
        </div>

        <div class="row">
          <span class="chip">üö´ blocked: <span class="mono" id="blocked">‚Äî</span></span>
          <span class="chip">üïí updated: <span class="mono" id="updated">‚Äî</span></span>
        </div>

        <div class="row">
          <span class="chip">üè´ campus_id: <span class="mono" id="campusId">‚Äî</span></span>
          <span class="chip">üè´ campus: <span class="mono" id="campusName">‚Äî</span></span>
        </div>

        <div class="row">
            <span class="chip">üß± zones: <span class="mono" id="zonesDbg">‚Äî</span></span>
            <span class="chip">üß© rows: <span class="mono" id="rowsDbg">‚Äî</span></span>
        </div>

        <div style="height:14px;"></div>
        <div class="chip">üéì Promo</div>
        <div class="barList" id="promoBars"></div>

        <div style="height:14px;"></div>
        <div class="chip">üë§ Kind</div>
        <div class="barList" id="kindBars"></div>

        <div class="row" style="margin-top:14px;">
          <button class="btn" id="btn-refresh">Refresh</button>
        </div>

        <div class="msg" id="statusMsg" style="display:none;"></div>
      </div>

      <!-- RIGHT: map -->
      <div class="card">
        <div class="tabs">
          <button class="tab active" id="tab-io">Io</button>
          <button class="tab" id="tab-disc">Discovery</button>
        </div>

        <!-- –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∑–æ–Ω—ã -->
        <div class="mapWrap" id="mapZones"></div>
      </div>
    </div>
  </div>

<div class="modalOverlay" id="userModalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div class="modalTitle">Student</div>
      <button class="modalClose" id="userModalClose">Close</button>
    </div>

    <div class="modalBody">
      <div class="modalAvatar">
        <img id="userModalAvatar" alt="" referrerpolicy="no-referrer" />
      </div>

      <div class="modalInfo">
        <h2 id="userModalName">‚Äî</h2>
        <div class="sub" id="userModalLogin">‚Äî</div>
        <div class="modalActions">
          <a class="modalLink" id="userModalProfileLink" href="#" target="_blank" rel="noreferrer noopener" aria-disabled="true">
            üîó Open Intra profile
          </a>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <span class="pill">‚≠ê level: <span class="mono" id="userModalLevel">‚Äî</span></span>
          <span class="pill">üéì promo: <span class="mono" id="userModalPromo">‚Äî</span></span>
          <span class="pill">üë§ kind: <span class="mono" id="userModalKind">‚Äî</span></span>
        </div>
      </div>
    </div>
  </div>
</div>


  <script>

    // === User Modal ===
    const modalOverlay = document.getElementById("userModalOverlay");
    const modalCloseBtn = document.getElementById("userModalClose");

    // async function openUserModal(user){
    // if (!user) return;

    // document.getElementById("userModalName").textContent = user.displayname || user.login || "‚Äî";
    // document.getElementById("userModalLogin").textContent = user.login ? `@${user.login}` : "‚Äî";
    // document.getElementById("userModalLevel").textContent = (user.level != null) ? String(user.level) : "‚Äî";
    // document.getElementById("userModalPromo").textContent = user.pool_year || "‚Äî";
    // document.getElementById("userModalKind").textContent = user.kind || "‚Äî";

    // const img = document.getElementById("userModalAvatar");
    // img.src = user.avatar_large || user.avatar || "";
    // img.alt = user.displayname || user.login || "";

    // // –µ—Å–ª–∏ level –Ω–µ—Ç ‚Äî –¥–æ–≥—Ä—É–∂–∞–µ–º –∏–∑ Worker –ø–æ –∫–ª–∏–∫—É
    // if (user?.id && (user.level == null)) {
    //     try {
    //         const session = new URLSearchParams(location.search).get("session");
    //         const r = await fetch(`${API_BASE}/user?session=${encodeURIComponent(session)}&id=${encodeURIComponent(user.id)}`);
    //         const j = await r.json();
    //         if (j?.ok && j?.user) {
    //         // –æ–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª–∫—É ‚Äú–Ω–∞ –ª–µ—Ç—É‚Äù
    //         document.getElementById("userModalLevel").textContent =
    //             (j.user.level != null) ? String(j.user.level) : "‚Äî";

    //         const img = document.getElementById("userModalAvatar");
    //         img.src = j.user.avatar_large || j.user.avatar || img.src;
    //         }
    //     } catch {}
    // }

    // console.log("openUserModal", user);
    // modalOverlay.classList.add("show");
    // modalOverlay.setAttribute("aria-hidden", "false");
    // }
    function trunc2(v){
        const n = Number(v);
        if (!Number.isFinite(n)) return "‚Äî";
        return (Math.floor(n * 100) / 100).toFixed(2);
    }

    async function openUserModal(user) {
        if (!user) return;

        // 1) –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ, —á—Ç–æ –µ—Å—Ç—å
        document.getElementById("userModalName").textContent = user.displayname || user.login || "‚Äî";
        document.getElementById("userModalLogin").textContent = user.login ? `@${user.login}` : "‚Äî";
        document.getElementById("userModalLevel").textContent = (user.level != null) ? String(user.level) : "‚Äî";
        document.getElementById("userModalPromo").textContent = user.pool_year || "‚Äî";
        document.getElementById("userModalKind").textContent = user.kind || "‚Äî";

        const img = document.getElementById("userModalAvatar");
        img.src = user.avatar_large || user.avatar || "";
        img.alt = user.displayname || user.login || "";

        const profileLink = document.getElementById("userModalProfileLink");
        if (user.login) {
            profileLink.href = `https://profile.intra.42.fr/users/${encodeURIComponent(user.login)}`;
            profileLink.setAttribute("aria-disabled", "false");
        } else {
            profileLink.href = "#";
            profileLink.setAttribute("aria-disabled", "true");
        }
        
        modalOverlay.classList.add("show");

        // 2) –¥–æ–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
        const session = getSessionFromStorageOrUrl();
        console.log("session from storage/url =", session);

        if (!session) {
            console.warn("No session found. /user call skipped.");
            document.getElementById("userModalLevel").textContent = "‚Äî";
            return;
        }

        try {
            const url = `${WORKER}/user?session=${encodeURIComponent(session)}&id=${encodeURIComponent(user.id)}`;

            const r = await fetch(url);

            // —á–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–∞–∂–µ –Ω–µ-JSON –æ—Ç–≤–µ—Ç—ã
            const text = await r.text();
            let j;
            try {
            j = JSON.parse(text);
            } catch (e) {
            console.error("Response is not JSON. Parse error:", e);
            return;
            }

            if (!j?.ok) return;

            const full = j.user;
            const derived = j.derived || {};

            // document.getElementById("userModalLevel").textContent =
            // (derived.level42 != null) ? String(derived.level42) : "‚Äî";
            document.getElementById("userModalLevel").textContent =
            (derived.level42 != null) ? trunc2(derived.level42) : "‚Äî";

            img.src = derived.avatar_large || derived.avatar || img.src;

            console.log("full user profile:", full);
        } catch (e) {
            console.error("Failed to load full user:", e);
        }
    }




    function closeUserModal(){
    modalOverlay.classList.remove("show");
    modalOverlay.setAttribute("aria-hidden", "true");
    }

    modalCloseBtn.onclick = closeUserModal;
    modalOverlay.addEventListener("click", (e) => {
    if (e.target === modalOverlay) closeUserModal();
    });
    document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeUserModal();
    });


    // === CONFIG ===
    const WORKER = "https://cluster-42.tigran-sargsyan-w.workers.dev"; // <-- –æ—Å—Ç–∞–≤—å —Å–≤–æ–π
    const LOGIN_PAGE = "login.html";
    const CLUSTER_PAGE = "cluster.html";

    const ROW_FIRST_POSITION = {
      // –ø—Ä–∏–º–µ—Ä—ã:
      // "Z1:R1": "top",
      // "Z1:R2": "bottom",
      // "R3": "top",
      "Z1:R1": "bottom",
      "Z2:R1": "top",
      "Z3:R1": "bottom",
      "Z4:R1": "bottom",
    };

    // Io: Z1,Z2 | Discovery: Z3,Z4
    let activeTab = "io";

    // === UI wiring ===
    document.getElementById("btn-login").onclick = () => location.href = `${WORKER}/login`;
    document.getElementById("btn-logout").onclick = () => { localStorage.removeItem("session"); location.href = LOGIN_PAGE; };
    document.getElementById("btn-refresh").onclick = () => load();

    document.getElementById("tab-io").onclick = () => { activeTab = "io"; setTab(true); load(); };
    document.getElementById("tab-disc").onclick = () => { activeTab = "discovery"; setTab(false); load(); };

    function setTab(isIo){
      document.getElementById("tab-io").classList.toggle("active", isIo);
      document.getElementById("tab-disc").classList.toggle("active", !isIo);
    }

    // === Helpers ===
    function el(tag, attrs={}, ...children){
      const node = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)){
        if (k === "class") node.className = v;
        else if (k === "html") node.innerHTML = v;
        else node.setAttribute(k, v);
      }
      for (const ch of children){
        if (ch == null) continue;
        node.appendChild(typeof ch === "string" ? document.createTextNode(ch) : ch);
      }
      return node;
    }

    function fmtTime(iso){
      if (!iso) return "‚Äî";
      const d = new Date(iso);
      return isNaN(d) ? iso : d.toLocaleTimeString("ru-RU", { hour:"2-digit", minute:"2-digit", second:"2-digit" });
    }

    function renderBars(container, obj){
      container.innerHTML = "";
      const entries = Object.entries(obj || {}).sort((a,b) => b[1]-a[1]);
      if (!entries.length) {
        container.appendChild(el("div", { class:"muted" }, "‚Äî"));
        return;
      }
      const max = Math.max(...entries.map(e => e[1]));
      for (const [k,v] of entries) {
        const row = el("div", { class:"barRow" },
          el("div", { class:"mono muted" }, k),
          (() => {
            const bar = el("div", { class:"bar" }, el("i"));
            bar.firstChild.style.width = `${Math.round((v/max)*100)}%`;
            return bar;
          })(),
          el("div", { class:"mono" }, String(v))
        );
        container.appendChild(row);
      }
    }

    // function filterZonesByTab(zones){
    //   const hasZ1 = zones.some(z => z.name === "Z1");
    //   const hasZ2 = zones.some(z => z.name === "Z2");
    //   const hasZ3 = zones.some(z => z.name === "Z3");
    //   const hasZ4 = zones.some(z => z.name === "Z4");

    //   // –µ—Å–ª–∏ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—Ö–µ–º–∞ Z1..Z4 ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤–æ
    //   if (hasZ1 || hasZ2 || hasZ3 || hasZ4) {
    //     if (activeTab === "io") {
    //       const z = zones.filter(x => x.name === "Z1" || x.name === "Z2");
    //       return z.length ? z : zones;
    //     } else {
    //       const z = zones.filter(x => x.name === "Z3" || x.name === "Z4");
    //       return z.length ? z : zones;
    //     }
    //   }

    //   // –∏–Ω–∞—á–µ (–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –∏–º–µ–Ω–∞ –∑–æ–Ω) ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—ë
    //   return zones;
    // }

    function filterZonesByTab(zones){
      const hasZ1 = zones.some(z => z.name === "Z1");
      const hasZ2 = zones.some(z => z.name === "Z2");
      const hasZ3 = zones.some(z => z.name === "Z3");
      const hasZ4 = zones.some(z => z.name === "Z4");
      const byName = new Map(zones.map(z => [z.name, z]));

      // –µ—Å–ª–∏ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—Ö–µ–º–∞ Z1..Z4 ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤–æ
      if (hasZ1 || hasZ2 || hasZ3 || hasZ4) {
        if (activeTab === "io") {
          const ordered = ["Z2","Z1"].map(n => byName.get(n)).filter(Boolean);
            return ordered.length ? ordered : zones;
        } else {
          const ordered = ["Z4","Z3"].map(n => byName.get(n)).filter(Boolean);
            return ordered.length ? ordered : zones;
        }
      }

      // –∏–Ω–∞—á–µ (–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –∏–º–µ–Ω–∞ –∑–æ–Ω) ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—ë
      return zones;
    }

    function resolveZoneStartPosition(zone){
      const zoneName = zone?.name;
      if (!zoneName) return null;

      const direct = ROW_FIRST_POSITION[zoneName];
      if (direct === "top" || direct === "bottom") return direct;

      const firstRowName = zone?.rows?.[0]?.name || "R1";
      const key = `${zoneName}:${firstRowName}`;
      const fallback = ROW_FIRST_POSITION[key];
      return (fallback === "top" || fallback === "bottom") ? fallback : null;
    }

    function resolveRowStartPosition(zoneName, row, zoneDefault){
      const explicit =
        row?.first_position ||
        row?.firstPosition ||
        row?.start_position ||
        row?.startPosition;
      if (explicit === "top" || explicit === "bottom") return explicit;

      const key = `${zoneName}:${row.name}`;
      return ROW_FIRST_POSITION[key]
        || zoneDefault
        || ROW_FIRST_POSITION[row.name]
        || "top";
    }

    function renderZoneInto(container, zone){
      const inner = el("div", { class:"zoneInner" });
      const zoneDefault = resolveZoneStartPosition(zone);

      for (const r of zone.rows) {
        const startPosition = resolveRowStartPosition(zone.name, r, zoneDefault);
        const seats = el("div", { class:"seats" },
          // ...r.seats.map(s => {
          ...r.seats.map((s, idx) => {
            const isUp = (startPosition === "bottom")
              ? idx % 2 === 1
              : idx % 2 === 0;

            const seat = el("div", { class:`seat ${s.status}` });

            if (s.status === "occupied" && s.user?.avatar) {
              seat.appendChild(el("img", { src:s.user.avatar, alt:s.user.login, referrerpolicy:"no-referrer" }));
              seat.appendChild(el("div", { class:"tooltip" },
                `${s.user.login} ‚Ä¢ promo ${s.user.pool_year || "‚Äî"}`
              ));
            } else if (s.status === "blocked") {
              seat.appendChild(el("div", { class:"ban" }, "üö´"));
            }

            if (s.status === "occupied") {
            seat.style.cursor = "pointer";
            seat.addEventListener("click", () => openUserModal(s.user));
            }

            // return el("div", { class:"seatCol" },
            return el("div", { class:`seatCol ${isUp ? "up" : "down"}` },
              seat,
              el("div", { class:"seatNum mono" }, String(s.post))
            );
          })
        );

        inner.appendChild(
          el("div", { class:"zoneRow" },
            seats,
            el("div", { class:"rowLabel" }, r.name)
          )
        );
      }

      const zoneBox = el("div", { class:"zone" },
        el("div", { class:"zoneTitle" }, zone.name),
        inner
      );

      container.appendChild(zoneBox);
    }

    function setStatusMsg(text){
      const box = document.getElementById("statusMsg");
      if (!text) { box.style.display = "none"; box.textContent = ""; return; }
      box.style.display = "block";
      box.textContent = text;
    }

    // === Session + Campus ===
    function getSessionFromStorageOrUrl(){
      const url = new URL(location.href);
      return url.searchParams.get("session") || localStorage.getItem("session");
    }


    async function getSessionIdFromUrlOrStorage(){
      const url = new URL(location.href);
      const sessionFromUrl = url.searchParams.get("session");
      const session = sessionFromUrl || localStorage.getItem("session");

      if (!session) return null;

      localStorage.setItem("session", session);
      if (sessionFromUrl){
        url.searchParams.delete("session");
        history.replaceState({}, "", url.toString());
      }
      return session;
    }

    async function getPrimaryCampus(session){
      const res = await fetch(`${WORKER}/session?session=${encodeURIComponent(session)}`);
      if (!res.ok) throw new Error("Session invalid/expired");

      const data = await res.json();
      const cu = data?.me?.campus_users || [];
      // const primary = cu.find(x => x?.is_primary);
      // return primary?.campus_id || cu[0]?.campus_id || null;
      const primary = cu.find(x => x?.is_primary) || cu[0] || null;
      const campusId = primary?.campus_id || null;
      const campus = (data?.me?.campus || []).find(c => c?.id === campusId) || (data?.me?.campus || [])[0];
      return { id: campusId, name: campus?.name || "‚Äî" };
    }

    // === Main load ===
    async function load(){
      setStatusMsg("");

      const session = await getSessionIdFromUrlOrStorage();
      if (!session){
        document.getElementById("updated").textContent = "No session";
        setStatusMsg("–ù–µ—Ç session. –û—Ç–∫—Ä–æ–π login.html –∏ –∑–∞–ª–æ–≥–∏–Ω—å—Å—è.");
        return;
      }

      let campus;
      try {
        campus = await getPrimaryCampus(session);
      } catch (e) {
        document.getElementById("updated").textContent = "Session expired";
        localStorage.removeItem("session");
        setStatusMsg("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞/–Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞. –ù–∞–∂–º–∏ Login.");
        return;
      }

      if (!campus?.id){
        document.getElementById("updated").textContent = "No campus_id";
        setStatusMsg("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å campus_id –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è (/v2/me).");
        return;
      }

      // document.getElementById("campusId").textContent = String(campusId);
      document.getElementById("campusId").textContent = String(campus.id);
      document.getElementById("campusName").textContent = campus.name || "‚Äî";

      const api = `${WORKER}/cluster?session=${encodeURIComponent(session)}&campus_id=${encodeURIComponent(campus.id)}`;

      const res = await fetch(api);
      if (!res.ok){
        const text = await res.text().catch(() => "");
        document.getElementById("updated").textContent = `API error ${res.status}`;
        setStatusMsg(`Worker /cluster –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É ${res.status}.\n${text}`);
        return;
      }

      const data = await res.json();
      // console.log("cluster data", data);
      console.log("campus", campus);

      // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        window.__lastCluster = data;

        // –≤—ã–≤–µ—Å—Ç–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—è–¥–æ–≤ –ø–æ –∑–æ–Ω–∞–º
        const zones = Array.isArray(data.zones) ? data.zones : [];
        document.getElementById("zonesDbg").textContent =
        zones.length ? zones.map(z => z.name).join(",") : "none";

        document.getElementById("rowsDbg").textContent =
        zones.length ? zones.map(z => `${z.name}:${z.rows?.length ?? 0}`).join(" | ") : "‚Äî";

      if (!data?.ok){
        document.getElementById("updated").textContent = "Bad response";
        setStatusMsg("–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç /cluster.");
        return;
      }

      document.getElementById("occ").textContent = data.stats?.occupied ?? "‚Äî";
      document.getElementById("free").textContent = data.stats?.free ?? "‚Äî";
      document.getElementById("blocked").textContent = data.stats?.blocked ?? "‚Äî";
      document.getElementById("updated").textContent = fmtTime(data.updated_at);
      // document.getElementById("seatmapSource").textContent = data.seatmap_source || "‚Äî";

      renderBars(document.getElementById("promoBars"), data.stats?.promo);
      renderBars(document.getElementById("kindBars"), data.stats?.kind);

    //   const zones = Array.isArray(data.zones) ? data.zones : [];
      const map = document.getElementById("mapZones");
      map.innerHTML = "";

      if (!zones.length){
        setStatusMsg(
          `Seatmap –ø—É—Å—Ç–æ–π (seatmap_source=${data.seatmap_source || "‚Äî"}).
–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ Worker –µ—â—ë –Ω–µ –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–∞ host-–ø–∞—Ä—Å–∏–Ω–≥ –∏–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ –Ω–µ—Ç host-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç.`
        );
        return;
      }

      const visible = filterZonesByTab(zones);
      for (const z of visible) renderZoneInto(map, z);
    }

    // —Å—Ç–∞—Ä—Ç
    load();
  </script>
</body>
</html>
